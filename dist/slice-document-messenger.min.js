/*!
  * Slice document messenger.1.0.0 (https://github.com/shininglab-code/slice-document-messenger)
  * Copyright 2020 shininglab (https://github.com/shininglab-code)
  * Licensed under MIT
  */(function(a,b){if("function"==typeof define&&define.amd)define([],b);else if("undefined"!=typeof exports)b();else{b(),a.sliceDocumentMessenger={exports:{}}.exports}})("undefined"==typeof globalThis?"undefined"==typeof self?this:self:globalThis,function(){"use strict";function a(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function b(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function c(a,b){a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.__proto__=b}var d=/*#__PURE__*/function(){function a(a,b){this.name=a||null,this.data=b||{}}a.create=function create(b,c){return new a(b,c)},a.fromJSON=function fromJSON(b){var c=null,d={};try{var e=JSON.parse(b);"object"==typeof e&&(e.hasOwnProperty("name")&&(c=e.name),e.hasOwnProperty("data")&&"object"==typeof e.data&&(d=e.data))}catch(a){c="MessageParseError",d={error:a,raw:b}}return new a(c,d)};var b=a.prototype;return b.toString=function toString(){return JSON.stringify({name:this.name,data:this.data})},a}(),e=/*#__PURE__*/function(){function a(){this.receivers={}}a.getAddress=function getAddress(a){return"transport-"+a},a.isAvailable=function isAvailable(){return!0};var b=a.prototype;return b.isAvailable=function isAvailable(){return this.constructor.isAvailable()},b.addReceiver=function addReceiver(a,b){var c=this.constructor.getAddress(a);return this.receivers.hasOwnProperty(c)||(this.receivers[c]=[]),this.receivers[c].push(b),this},b.removeReceiver=function removeReceiver(a,b){var c=this.constructor.getAddress(a);if(this.receivers.hasOwnProperty(c)){var d=this.receivers[c].indexOf(b);-1<d&&this.receivers[c].splice(d,1)}return this},b.hasAddress=function hasAddress(a,b){var c=b?a:this.constructor.getAddress(a);return this.receivers.hasOwnProperty(c)&&this.receivers[c].length},b.receive=function receive(a,b,c){var d=c?a:this.constructor.getAddress(a);return this.receivers.hasOwnProperty(d)&&this.receivers[d].map(function(a){a(b)}),this},b.send=function send(a,b){return window.console&&console.log(this.constructor.getAddress(a)+": "+b.toString()),this},b.remove=function remove(){this.receivers={}},a}(),f=/*#__PURE__*/function(a){function e(){var c;return c=a.call(this)||this,c.handle=c.handle.bind(b(c)),window.addEventListener("storage",c.handle),c}c(e,a);var f=e.prototype;return f.handle=function handle(a){if(!this.hasAddress(a.key,!0)||null===a.newValue)return null;var b=d.fromJSON(a.newValue);return this.receive(a.key,b,!0)},f.send=function send(a,b){var c=this.constructor.getAddress(a);return localStorage.setItem(c,b.toString()),localStorage.removeItem(c),this},f.remove=function remove(){window.removeEventListener("storage",this.handle),a.prototype.remove.call(this)},e}(e),g=/*#__PURE__*/function(){function a(a,b,c,d){void 0===a&&(a={}),void 0===b&&(b={}),this.settings=b,this.owner=a,c&&this.setMessenger(c,d)}var b=a.prototype;return b.setMessenger=function setMessenger(a,b,c){return this.messenger&&c&&this.messenger.removeBox(this),a instanceof h&&(this.messenger=a,b&&this.messenger.addBox(this)),this},b.receive=function receive(a){if(a.name){var b=this.settings,c=null,d=b.handlers&&b.handlers.hasOwnProperty(a.name)?b.handlers[a.name]:b.defaultHandler||null;if(d&&("string"==typeof d&&(d={self:!1,handler:d}),d.self?this[d.handler]&&(c=this[d.handler],this[d.handler](a)):this.owner[d.handler]&&(c=this.owner[d.handler])),c)c(a);else if(d)throw new Error("Can't handle message "+a.name+".")}return this},b.send=function send(a,b,c){if(this.messenger)this.messenger.send(a,b,c);else throw new Error("Can't send message: no messenger provided.");return this},b.sendSelf=function sendSelf(a,b,c){if(this.messenger)this.messenger.sendSelf(a,b,c);else throw new Error("Can't send message: no messenger provided.");return this},b.sendCurrent=function sendCurrent(a,b,c){if(this.messenger)this.messenger.sendCurrent(a,b,c);else throw new Error("Can't send message: no messenger provided.");return this},b.sendEveryone=function sendEveryone(a,b,c){if(this.messenger)this.messenger.sendEveryone(a,b,c);else throw new Error("Can't send message: no messenger provided.");return this},a}(),h=/*#__PURE__*/function(){function a(a,b){if(!a)throw new Error("Can't create messenger without id.");if(!(b instanceof e))throw new TypeError("Messenger transport should be instance of SliceMessageTransport.");this.timeouts={out:{},current:{},self:{}},this.id=a,this.receivers={},this.boxes=[],this.receive=this.receive.bind(this),this.transport=b,b.addReceiver(this.id,this.receive)}var b=a.prototype;return b.receive=function receive(a){if(this.boxes.length&&this.boxes.map(function(b){b.receive(a)}),a.name&&this.receivers.hasOwnProperty(a.name)){var b=this.receivers[a.name];b.map(function(b){b(a)})}return this},b.send=function send(a,b,c){var e=this,f=this.timeouts.out;if(f.hasOwnProperty(a)&&f[a]&&(clearTimeout(f[a]),delete f[a]),c)f[a]=setTimeout(function(){delete f[a],e.send(a,b)},!0===c?0:c);else{var g=d.create(a,b);this.transport.send(this.id,g)}return this},b.sendSelf=function sendSelf(a,b,c){var e=this,f=this.timeouts.self;if(f.hasOwnProperty(a)&&f[a]&&(clearTimeout(f[a]),delete f[a]),c)f[a]=setTimeout(function(){delete f[a],e.sendSelf(a,b)},!0===c?0:c);else{var g=d.create(a,b);this.receive(g)}return this},b.sendCurrent=function sendCurrent(a,b,c){var e=this,f=this.timeouts.current;if(f.hasOwnProperty(a)&&f[a]&&(clearTimeout(f[a]),delete f[a]),c)f[a]=setTimeout(function(){delete f[a],e.sendCurrent(a,b)},!0===c?0:c);else{var g=d.create(a,b);this.transport.receive(this.id,g)}return this},b.sendEveryone=function sendEveryone(a,b,c){return this.sendCurrent(a,b,c),this.send(a,b,c),this},b.addBox=function addBox(a){return a instanceof g&&this.boxes.push(a),this},b.removeBox=function removeBox(a){var b=this.boxes.indexOf(a);return-1<b&&this.boxes.splice(b,1),this},b.addReceiver=function addReceiver(a,b){return this.receivers.hasOwnProperty(a)||(this.receivers[a]=[]),this.receivers[a].push(b),this},b.removeReceiver=function removeReceiver(a,b){if(this.receivers.hasOwnProperty(a)){var c=this.receivers[a].indexOf(b);-1<c&&this.receivers[a].splice(c,1)}return this},b.remove=function remove(){for(var a in this.timeouts)if(this.timeouts.hasOwnProperty(a)){var b=this.timeouts[a];for(var c in b)b.hasOwnProperty(c)&&(clearTimeout(b[c]),delete b[c])}this.transport.removeReceiver(this.id,this.receive)},a}(),i=/*#__PURE__*/function(){function a(){}return a.addTransport=function addTransport(b){b instanceof e&&0>a.transports.indexOf(b)&&a.transports.push(b)},a.getIdFromURL=function getIdFromURL(a){var b=null,c="messengerId",d=a.indexOf("?")+1,e=a.indexOf("#")+1||a.length+1,f=a.slice(d,e-1);if(URLSearchParams){var i=new URLSearchParams("?"+f);i.has(c)&&(b=i.get(c))}else{var g=function(a){var b={};if(""===a)return b;for(var c=a.replace(/\+/g," ").split("&"),d=0;d<c.length;d++){var e=c[d].split("=",2),f=decodeURIComponent(e[0]),g=decodeURIComponent(e[1]);b.hasOwnProperty(f)||(b[f]=[]),b[f].push(2===e.length?g:null)}return b},h=g(f);h.hasOwnProperty(c)&&(b=h[c])}return b},a.getAvailableTransport=function getAvailableTransport(){var b=null;return a.transports.length&&a.transports.some(function(a){return!!a.isAvailable()&&(b=a,!0)}),b},a.createMessenger=function createMessenger(b,c){return void 0===b&&(b=a.getIdFromURL(location.search)),void 0===c&&(c=a.getAvailableTransport()),new h(b,c)},a}();a(i,"transports",[]),i.addTransport(new f),window.SliceMessage=d,window.SliceMessageTransport=e,window.SliceLocalStorageTransport=f,window.SliceMessenger=h,window.SliceMessageBox=g,window.SliceMessengerFactory=i});
//# sourceMappingURL=slice-document-messenger.min.js.map
